# **I. HÆ°á»›ng dáº«n má»Ÿ rá»™ng root filesystem trÃªn Linux sá»­ dá»¥ng LVM**

### **Má»¥c tiÃªu**

TÄƒng dung lÆ°á»£ng Logical Volume `ol-root` (root `/`) báº±ng cÃ¡ch sá»­ dá»¥ng **pháº§n trÄƒm dung lÆ°á»£ng trá»‘ng**, káº¿t há»£p vá»›i á»• Ä‘Ä©a má»›i `/dev/sdc`.

---

## **Thá»±c hiá»‡n má»Ÿ rá»™ng**

### **1ï¸âƒ£ Kiá»ƒm tra tráº¡ng thÃ¡i á»• Ä‘Ä©a vÃ  phÃ¢n vÃ¹ng**

```bash
Last login: Fri Aug  1 08:58:41 2025 from 192.168.49.1
[root@vbox ~]# lsblk
NAME              MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda                 8:0    0   60G  0 disk
â”œâ”€sda1              8:1    0    1G  0 part /boot
â””â”€sda2              8:2    0   59G  0 part
  â”œâ”€ol-root       252:0    0 35.6G  0 lvm  /
  â”œâ”€ol-swap       252:1    0    6G  0 lvm  [SWAP]
  â””â”€ol-home       252:3    0 17.4G  0 lvm  /home
sdb                 8:16   0    1G  0 disk
â””â”€vg_data-lv_home 252:2    0  100M  0 lvm
sdc                 8:32   0  1.1G  0 disk
sr0                11:0    1 1024M  0 rom
```

âœ… XÃ¡c Ä‘á»‹nh á»• Ä‘Ä©a má»›i `/dev/sdc` trá»‘ng vÃ  VG chá»©a root lÃ  `ol`.

---

### **2ï¸âƒ£ Khá»Ÿi táº¡o Physical Volume (PV)**

```bash
[root@vbox ~]# pvcreate /dev/sdc
  Physical volume "/dev/sdc" successfully created.

[root@vbox ~]# pvs
  PV         VG      Fmt  Attr PSize    PFree
  /dev/sda2  ol      lvm2 a--   <59.00g      0
  /dev/sdb   vg_data lvm2 a--  1020.00m 920.00m
  /dev/sdc           lvm2 ---    <1.07g  <1.07g
```

#### **ğŸ” Giáº£i thÃ­ch cÃ¡c thÃ´ng sá»‘ trong `pvs`**
| Cá»™t   | MÃ´ táº£                                                                 |
|-------|-----------------------------------------------------------------------|
| **PV**  | TÃªn Physical Volume (á»• Ä‘Ä©a váº­t lÃ½ Ä‘Ã£ Ä‘Æ°á»£c LVM hÃ³a)                     |
| **VG**  | TÃªn Volume Group mÃ  PV thuá»™c vá» (trá»‘ng = chÆ°a thuá»™c VG nÃ o)             |
| **Fmt** | Äá»‹nh dáº¡ng LVM (luÃ´n lÃ  `lvm2` trÃªn há»‡ thá»‘ng hiá»‡n Ä‘áº¡i)                   |
| **Attr**| Thuá»™c tÃ­nh PV:<br>`a` = allocatable (cÃ³ thá»ƒ cáº¥p phÃ¡t),<br>`-` = khÃ´ng cÃ³ tÃ­nh nÄƒng Ä‘áº·c biá»‡t |
| **PSize**| Tá»•ng kÃ­ch thÆ°á»›c PV (sau khi trá»« metadata LVM)                          |
| **PFree**| Dung lÆ°á»£ng trá»‘ng trÃªn PV                                              |

âœ… `/dev/sdc` Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o thÃ nh PV (chÆ°a thuá»™c VG nÃ o).

---

### **3ï¸âƒ£ Má»Ÿ rá»™ng Volume Group (VG)**

```bash
[root@vbox ~]# vgextend ol /dev/sdc
  Volume group "ol" successfully extended

[root@vbox ~]# vgs
  VG      #PV #LV #SN Attr   VSize    VFree
  ol        2   3   0 wz--n-   60.06g  <1.07g
  vg_data   1   1   0 wz--n- 1020.00m 920.00m
```

#### **ğŸ” Giáº£i thÃ­ch cÃ¡c thÃ´ng sá»‘ trong `vgs`**
| Cá»™t   | MÃ´ táº£                                                                 |
|-------|-----------------------------------------------------------------------|
| **VG**   | TÃªn Volume Group                                                     |
| **#PV**  | Sá»‘ lÆ°á»£ng Physical Volume trong VG                                    |
| **#LV**  | Sá»‘ lÆ°á»£ng Logical Volume trong VG                                     |
| **#SN**  | Sá»‘ lÆ°á»£ng snapshot (náº¿u cÃ³)                                           |
| **Attr** | Thuá»™c tÃ­nh VG:<br>`w` = writable,<br>`z` = resizable,<br>`n` = no snapshots |
| **VSize**| Tá»•ng kÃ­ch thÆ°á»›c VG (sau khi cá»™ng táº¥t cáº£ PV)                          |
| **VFree**| Dung lÆ°á»£ng trá»‘ng trong VG                                            |

âœ… VG `ol` Ä‘Ã£ tÄƒng thÃªm 1 PV vÃ  cÃ³ thÃªm **~1GB dung lÆ°á»£ng trá»‘ng**.

---

### **4ï¸âƒ£ Má»Ÿ rá»™ng Logical Volume (LV) báº±ng % - So sÃ¡nh trá»±c quan**

#### **ğŸ“Œ Báº£ng so sÃ¡nh cÃ¡c phÆ°Æ¡ng phÃ¡p má»Ÿ rá»™ng LV**
| PhÆ°Æ¡ng phÃ¡p | CÃ´ng thá»©c             | VÃ­ dá»¥ minh há»a (VG=60GB, Free=1GB, LV=35.61GB) | LV sau má»Ÿ rá»™ng | VG Free sau |
|-------------|-----------------------|------------------------------------------------|----------------|-------------|
| **%FREE**   | `-l +X%FREE`          | `lvextend -l +50%FREE /dev/mapper/ol-root`     | 36.11GB (+0.5GB) | 0.5GB       |
| **%VG**     | `-l X%VG`             | `lvextend -l 80%VG /dev/mapper/ol-root`        | 48GB           | 12GB*       |
| **%LV**     | `-L +X%LV`            | `lvextend -L +20%LV /dev/mapper/ol-root`       | 42.73GB (+7.12GB) | 0GB**       |

> **\* LÆ°u Ã½:**  
> - **%VG 80%** = 80% tá»•ng dung lÆ°á»£ng VG (60GB Ã— 0.8 = 48GB).  
> - **%LV 20%** chá»‰ thÃ nh cÃ´ng náº¿u VG cÃ³ Ä‘á»§ dung lÆ°á»£ng trá»‘ng (trong vÃ­ dá»¥ nÃ y cáº§n 7.12GB nhÆ°ng chá»‰ cÃ³ 1GB â†’ **tháº¥t báº¡i**).  
> - **%FREE 50%** luÃ´n an toÃ n vÃ¬ chá»‰ sá»­ dá»¥ng dung lÆ°á»£ng trá»‘ng hiá»‡n cÃ³.

---

#### **ğŸ’¡ Chi tiáº¿t tá»«ng phÆ°Æ¡ng phÃ¡p**

##### **1ï¸âƒ£ %FREE â€“ Pháº§n trÄƒm dung lÆ°á»£ng trá»‘ng cá»§a VG**
```bash
lvextend -l +100%FREE /dev/mapper/ol-root
```
- **CÃ´ng thá»©c**: `+X%FREE` = TÄƒng thÃªm **X%** cá»§a dung lÆ°á»£ng trá»‘ng trong VG.
- **VÃ­ dá»¥**:  
  VG `ol` cÃ²n trá»‘ng **1GB** â†’ `+100%FREE` = TÄƒng thÃªm **1GB** cho LV.
- **Æ¯u Ä‘iá»ƒm**: LuÃ´n Ä‘áº£m báº£o khÃ´ng vÆ°á»£t quÃ¡ dung lÆ°á»£ng trá»‘ng.

---

##### **2ï¸âƒ£ %VG â€“ Pháº§n trÄƒm tá»•ng dung lÆ°á»£ng VG**
```bash
lvextend -l 80%VG /dev/mapper/ol-root
```
- **CÃ´ng thá»©c**: `X%VG` = Äáº·t kÃ­ch thÆ°á»›c LV báº±ng **X%** tá»•ng dung lÆ°á»£ng VG.
- **VÃ­ dá»¥**:  
  VG `ol` cÃ³ tá»•ng **60GB** â†’ `80%VG` = LV sáº½ chiáº¿m **48GB** (dÃ¹ Ä‘ang á»Ÿ má»©c bao nhiÃªu).
- **Cáº£nh bÃ¡o**: CÃ³ thá»ƒ tháº¥t báº¡i náº¿u VG khÃ´ng Ä‘á»§ dung lÆ°á»£ng trá»‘ng.

---

##### **3ï¸âƒ£ %LV â€“ Pháº§n trÄƒm so vá»›i kÃ­ch thÆ°á»›c hiá»‡n táº¡i cá»§a LV**
```bash
lvextend -L +20%LV /dev/mapper/ol-root
```
- **CÃ´ng thá»©c**: `+X%LV` = TÄƒng thÃªm **X%** kÃ­ch thÆ°á»›c LV hiá»‡n táº¡i.
- **VÃ­ dá»¥**:  
  LV `ol-root` Ä‘ang lÃ  **35.61GB** â†’ `+20%LV` = TÄƒng thÃªm **7.12GB** (35.61 Ã— 0.2).
- **Háº¡n cháº¿**: Dá»… tháº¥t báº¡i náº¿u VG khÃ´ng Ä‘á»§ dung lÆ°á»£ng trá»‘ng.

---

### **5ï¸âƒ£ Kiá»ƒm tra loáº¡i filesystem**

```bash
[root@vbox ~]# df -T /
Filesystem          Type 1K-blocks    Used Available Use% Mounted on
/dev/mapper/ol-root xfs   37320904 8510184  28810720  23% /
```

#### **ğŸ” Giáº£i thÃ­ch cá»™t trong `df -T`**
| Cá»™t          | MÃ´ táº£                                                                 |
|--------------|-----------------------------------------------------------------------|
| **Filesystem**| Thiáº¿t bá»‹ hoáº·c mount point                                            |
| **Type**      | Loáº¡i filesystem (XFS, ext4, btrfs, v.v.)                              |
| **1K-blocks** | Tá»•ng sá»‘ block 1KB                                                     |
| **Used**      | Dung lÆ°á»£ng Ä‘Ã£ dÃ¹ng                                                   |
| **Available** | Dung lÆ°á»£ng trá»‘ng                                                     |
| **Use%**      | Pháº§n trÄƒm sá»­ dá»¥ng                                                    |
| **Mounted on**| Äiá»ƒm mount                                                           |

> **ğŸ’¡ ChÃº thÃ­ch:**
>
> * Vá»›i **ext4**, má»Ÿ rá»™ng filesystem dÃ¹ng:
>
>   ```bash
>   resize2fs /dev/mapper/ol-root
>   ```
>
>   (cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh trá»±c tiáº¿p block device hoáº·c mount point).
> * Vá»›i **XFS**, báº¯t buá»™c dÃ¹ng:
>
>   ```bash
>   xfs_growfs /
>   ```
>
>   (chá»‰ dÃ¹ng **mount point**, vÃ¬ XFS chá»‰ há»— trá»£ má»Ÿ rá»™ng **online** trÃªn filesystem Ä‘ang mount).

---

### **6ï¸âƒ£ Má»Ÿ rá»™ng filesystem (XFS)**

```bash
[root@vbox ~]# xfs_growfs /
meta-data=/dev/mapper/ol-root    isize=512    agcount=4, agsize=2333696 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1    bigtime=0 inobtcount=0
data     =                       bsize=4096   blocks=9334784, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=4558, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
data blocks changed from 9334784 to 9596928
```

âœ… Filesystem Ä‘Ã£ Ä‘Æ°á»£c má»Ÿ rá»™ng vÃ  nháº­n diá»‡n dung lÆ°á»£ng má»›i.

> **ğŸ’¡ ChÃº thÃ­ch:** Vá»›i **XFS**, lá»‡nh `xfs_growfs` luÃ´n yÃªu cáº§u **mount point** (vÃ­ dá»¥ `/`), **khÃ´ng chá»‰ Ä‘á»‹nh trá»±c tiáº¿p block device** nhÆ° `/dev/mapper/ol-root`.
> Äiá»u nÃ y vÃ¬ XFS há»— trá»£ má»Ÿ rá»™ng **online** vÃ  thao tÃ¡c nÃ y chá»‰ há»£p lá»‡ khi filesystem Ä‘ang Ä‘Æ°á»£c mount.


---

### **7ï¸âƒ£ Kiá»ƒm tra káº¿t quáº£ cuá»‘i cÃ¹ng**

```bash
[root@vbox ~]# df -h
Filesystem           Size  Used Avail Use% Mounted on
/dev/mapper/ol-root   37G  8.2G   29G  23% /
/dev/mapper/ol-home   18G  158M   18G   1% /home
/dev/sda1           1014M  680M  335M  67% /boot
```

âœ… Root filesystem tÄƒng tá»« **36GB â†’ 37GB**, má»Ÿ rá»™ng thÃ nh cÃ´ng.

---

## **SÆ¡ Ä‘á»“ minh há»a**

### **1ï¸âƒ£ SÆ¡ Ä‘á»“ Kiáº¿n trÃºc LVM**

```mermaid
graph TD
    subgraph "á»” Ä‘Ä©a váº­t lÃ½"
        A("á»” Ä‘Ä©a 1<br/>/dev/sda2"):::disk1
        B("á»” Ä‘Ä©a 2<br/>/dev/sdb1"):::disk2
        C("á»” Ä‘Ä©a má»›i<br/>/dev/sdc"):::disk_new
    end

    subgraph "LVM Layer"
        PV1["PV<br/>/dev/sda2"]:::pv1
        PV2["PV<br/>/dev/sdb1"]:::pv2
        PV_New["PV<br/>/dev/sdc"]:::pv_new

        VG(("Volume Group<br/>ol")):::vg

        LV1["/root"]:::lv_root
        LV2["/home"]:::lv_home
        LV3["swap"]:::lv_swap
    end

    A --> PV1
    B --> PV2
    C --> PV_New

    PV1 --> VG
    PV2 --> VG
    PV_New --> VG

    VG --> LV1
    VG --> LV2
    VG --> LV3

    classDef disk1 fill:#FF6B6B,stroke:#E55353,stroke-width:4px,color:#FFFFFF
    classDef disk2 fill:#4ECDC4,stroke:#45B7B8,stroke-width:4px,color:#FFFFFF
    classDef disk_new fill:#45B7D1,stroke:#3498DB,stroke-width:4px,color:#FFFFFF
    
    classDef pv1 fill:#96CEB4,stroke:#78B198,stroke-width:4px,color:#2C3E50
    classDef pv2 fill:#FFEAA7,stroke:#FDCB6E,stroke-width:4px,color:#2C3E50
    classDef pv_new fill:#DDA0DD,stroke:#DA70D6,stroke-width:4px,color:#FFFFFF
    
    classDef vg fill:#A29BFE,stroke:#6C5CE7,stroke-width:5px,color:#FFFFFF
    
    classDef lv_root fill:#FD79A8,stroke:#E84393,stroke-width:4px,color:#FFFFFF
    classDef lv_home fill:#00B894,stroke:#00A085,stroke-width:4px,color:#FFFFFF
    classDef lv_swap fill:#FDCB6E,stroke:#E17055,stroke-width:4px,color:#FFFFFF
```

---

### **2ï¸âƒ£ Quy trÃ¬nh táº¡o Physical Volume**

```mermaid
stateDiagram-v2
    direction LR
    
    state "á»” Ä‘Ä©a thÃ´" as Unmanaged {
        [*] --> Raw
        Raw : /dev/sdc
        Raw : KhÃ´ng quáº£n lÃ½
        Raw : Tráº¡ng thÃ¡i gá»‘c
        state Raw {
            bgcolor: #FF7675
        }
    }
    
    state "Khá»Ÿi táº¡o" as Creating {
        Processing --> Formatting
        Formatting --> Metadata
        Metadata : Táº¡o LVM metadata
        state Processing {
            bgcolor: #FDCB6E
        }
        state Formatting {
            bgcolor: #E17055
        }
        state Metadata {
            bgcolor: #00B894
        }
    }
    
    state "Physical Volume" as PV {
        Ready --> Available
        Available : Sáºµn sÃ ng thÃªm vÃ o VG
        Available : CÃ³ thá»ƒ cáº¥p phÃ¡t
        state Ready {
            bgcolor: #74B9FF
        }
        state Available {
            bgcolor: #00CEC9
        }
    }

    [*] --> Unmanaged
    Unmanaged --> Creating : pvcreate /dev/sdc
    Creating --> PV : ThÃ nh cÃ´ng
    
    note right of PV
        Tráº¡ng thÃ¡i: PV Ä‘Ã£ sáºµn sÃ ng
        Dung lÆ°á»£ng: ~1.07G
        Quáº£n lÃ½: CÃ³ thá»ƒ quáº£n lÃ½ bá»Ÿi LVM
    end note
```

---

### **3ï¸âƒ£ Má»Ÿ rá»™ng Volume Group**

```mermaid
graph TD
    subgraph "TrÆ°á»›c khi má»Ÿ rá»™ng"
        VG_before(("VG ol<br/>59G<br/>0G Free")):::vg_before
        PV1["PV /dev/sda2<br/>59G"]:::pv1 --> VG_before
    end

    PV_New("PV /dev/sdc<br/>~1G<br/>ChÆ°a thuá»™c VG"):::pv_new

    subgraph "Sau khi má»Ÿ rá»™ng"
        VG_after(("VG ol<br/>60G<br/>1G Free")):::vg_after
        PV1_after["PV /dev/sda2<br/>59G"]:::pv1_after --> VG_after
        PV_New_after["PV /dev/sdc<br/>~1G"]:::pv_new_after --> VG_after
    end

    PV_New -.->|"vgextend ol /dev/sdc"| VG_after

    classDef pv1 fill:#FF6B9D,stroke:#C44569,stroke-width:4px,color:#FFFFFF
    classDef pv1_after fill:#FF6B9D,stroke:#C44569,stroke-width:4px,color:#FFFFFF
    classDef pv_new fill:#A8E6CF,stroke:#7FCDCD,stroke-width:4px,color:#2C3E50
    classDef pv_new_after fill:#FFD93D,stroke:#FFC312,stroke-width:4px,color:#2C3E50
    classDef vg_before fill:#FF8A80,stroke:#F44336,stroke-width:4px,color:#FFFFFF
    classDef vg_after fill:#81C784,stroke:#4CAF50,stroke-width:5px,color:#FFFFFF
```

### **4ï¸âƒ£ SÆ¡ Ä‘á»“ luá»“ng hoÃ n chá»‰nh**

```mermaid
sequenceDiagram
    participant U as User (root)
    participant OS as Linux OS
    participant LVM as LVM Manager
    participant FS as Filesystem (XFS)

    autonumber
    
    Note over U,FS: Giai Ä‘oáº¡n kháº£o sÃ¡t há»‡ thá»‘ng
    U->>+OS: lsblk, pvs, vgs
    OS-->>-U: Hiá»ƒn thá»‹ cáº¥u trÃºc Ä‘Ä©a hiá»‡n táº¡i
    
    Note over U,FS: Giai Ä‘oáº¡n khá»Ÿi táº¡o PV
    U->>+LVM: pvcreate /dev/sdc
    LVM-->>-U: Physical Volume created
    
    Note over U,FS: Giai Ä‘oáº¡n má»Ÿ rá»™ng VG
    U->>+LVM: vgextend ol /dev/sdc
    LVM-->>-U: Volume Group extended (+1.07G)
    
    Note over U,FS: Giai Ä‘oáº¡n má»Ÿ rá»™ng LV
    U->>+LVM: lvextend -l +100%FREE /dev/mapper/ol-root
    LVM-->>-U: Logical Volume resized
    
    Note over U,FS: Giai Ä‘oáº¡n kiá»ƒm tra filesystem
    U->>+OS: df -T /
    OS-->>-U: Filesystem type: 'xfs'
    
    Note over U,FS: Giai Ä‘oáº¡n Ä‘á»“ng bá»™ filesystem
    U->>+FS: xfs_growfs /
    FS-->>-U: Filesystem expanded to new size
    
    Note over U,FS: Giai Ä‘oáº¡n xÃ¡c nháº­n káº¿t quáº£
    U->>+OS: df -h
    OS-->>-U: Hiá»ƒn thá»‹ dung lÆ°á»£ng má»›i: 37G
```