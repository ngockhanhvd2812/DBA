### Checklist Tinh Chỉnh Hệ Thống Trước Khi Cài Đặt MongoDB Sharded Cluster (Enterprise 8.0)


| Bước | Mô tả | Link | Trích đoạn ngắn gọn |
|------|--------|------|---------------------|
| 1. Kiểm tra Hardware Requirements | Đảm bảo mỗi mongod/mongos có ít nhất 2 real cores hoặc 1 multi-core CPU; ưu tiên CPU hỗ trợ AES-NI nếu dùng encryption; dùng SSD nếu có thể, hoặc SATA drives; tăng RAM để cải thiện I/O. | [https://www.mongodb.com/docs/v8.0/administration/production-notes/#std-label-prod-notes-hardware](https://www.mongodb.com/docs/v8.0/administration/production-notes/#std-label-prod-notes-hardware) | "At a minimum, ensure that each mongod or mongos instance has access to two real cores or one multi-core physical CPU. When using encryption, CPUs equipped with AES-NI instruction-set extensions show significant performance advantages. Use SSD if available and economical. Commodity (SATA) spinning drives are often a good option." |
| 2. Chọn Operating System & Kernel | Sử dụng Linux kernel 2.6.36+; các OS khuyến nghị: Amazon Linux, Debian, RHEL, SLES, Ubuntu LTS; chạy version mới nhất ổn định. | [https://www.mongodb.com/docs/v8.0/administration/production-notes/#std-label-prod-notes-operating-systems](https://www.mongodb.com/docs/v8.0/administration/production-notes/#std-label-prod-notes-operating-systems) | "While MongoDB supports a variety of platforms, the following operating systems are recommended for production use on x86_64 architecture: Amazon Linux, Debian, RHEL, SLES, Ubuntu LTS. When running MongoDB in production on Linux, you should use Linux kernel version 2.6.36 or later." |
| 3. Config Filesystem (XFS/EXT4, RAID, atime, NFS) | Sử dụng XFS (ưu tiên cho WiredTiger) hoặc EXT4; tắt atime cho volume chứa DB; dùng RAID-10 cho disks; nếu NFS, thêm options bg, hard, nolock, noatime, nointr vào /etc/fstab; tách data/journal/logs ra devices khác nhau nếu cần. | [https://www.mongodb.com/docs/v8.0/administration/production-notes/#std-label-prod-notes-filesystems](https://www.mongodb.com/docs/v8.0/administration/production-notes/#std-label-prod-notes-filesystems) | "Use Linux kernel version 2.6.36 or later, with either the XFS or EXT4 filesystem. If possible, use XFS as it generally performs better with MongoDB. Turn off atime for the storage volume containing the database files. For optimal performance in terms of the storage layer, use disks backed by RAID-10. If you decide to use NFS, add the following NFS options to your /etc/fstab file: bg, hard, nolock, noatime, nointr." |
| 4. Set vm.swappiness (Virtual Memory) | Set vm.swappiness = 1 hoặc 0 để tránh swapping; chỉnh trong /etc/sysctl.conf và apply bằng sysctl -p. | [https://www.mongodb.com/docs/v8.0/administration/production-notes/#std-label-prod-notes-virtual-memory-systems](https://www.mongodb.com/docs/v8.0/administration/production-notes/#std-label-prod-notes-virtual-memory-systems) | "MongoDB performs best where swapping can be avoided or kept to a minimum. As such you should set vm.swappiness to either 1 or 0 depending on your application needs and cluster configuration. Edit the /etc/sysctl.conf file and add the following line: vm.swappiness = 1, Run the following command to apply the setting: sudo sysctl -p." |
| 5. Set Read Ahead Settings | Set readahead giữa 8-32 cho WiredTiger, bất kể loại storage (HDD/SSD). | [https://www.mongodb.com/docs/v8.0/administration/production-notes/#std-label-prod-notes-readahead](https://www.mongodb.com/docs/v8.0/administration/production-notes/#std-label-prod-notes-readahead) | "For the WiredTiger storage engine: Set the readahead setting between 8 and 32 regardless of storage media type (spinning disk, SSD, etc.)." |
| 6. Disable NUMA (hoặc Config) | Tắt NUMA trong BIOS nếu có thể; nếu không, tắt zone reclaim bằng echo 0 > /proc/sys/vm/zone_reclaim_mode hoặc sysctl; start mongod/mongos bằng numactl --interleave=all. | [https://www.mongodb.com/docs/v8.0/administration/production-notes/#std-label-prod-notes-numa](https://www.mongodb.com/docs/v8.0/administration/production-notes/#std-label-prod-notes-numa) | "Disable NUMA in your BIOS. If that is not possible, see MongoDB on NUMA Hardware. On Linux, you must disable zone reclaim and also ensure that your mongod and mongos instances are started by numactl, which is generally configured through your platform's init system. Disable zone reclaim with one of the following commands: echo 0 | sudo tee /proc/sys/vm/zone_reclaim_mode, sudo sysctl -w vm.zone_reclaim_mode=0." |
| 7. Enable Transparent Huge Pages (THP) | Tạo service file /etc/systemd/system/enable-transparent-huge-pages.service với ExecStart set echo always/defer+madvise/0/1 cho enabled/defrag/max_ptes_none/overcommit; daemon-reload, start, enable. Hoặc dùng init.d script cho System V. | [https://www.mongodb.com/docs/v8.0/administration/tcmalloc-performance/](https://www.mongodb.com/docs/v8.0/administration/tcmalloc-performance/) | "If you are running MongoDB 8.0, enable Transparent Hugepages. For systems using systemd: Create /etc/systemd/system/enable-transparent-huge-pages.service ... ExecStart=/bin/sh -c 'echo always | tee /sys/kernel/mm/transparent_hugepage/enabled ...'. Then sudo systemctl daemon-reload; sudo systemctl start enable-transparent-huge-pages; sudo systemctl enable enable-transparent-huge-pages." |
| 8. Verify THP Settings | Chạy cat /sys/kernel/mm/transparent_hugepage/enabled && defrag && khugepaged/max_ptes_none && /proc/sys/vm/overcommit_memory; expected: always, defer+madvise, 0, 1. | [https://www.mongodb.com/docs/v8.0/administration/tcmalloc-performance/](https://www.mongodb.com/docs/v8.0/administration/tcmalloc-performance/) | "Verify: cat /sys/kernel/mm/transparent_hugepage/enabled && ... (expected: always defer+madvise 0 1)." |
| 9. Set ulimit Settings | Recommended: -f/-t/-v/-l/-m: unlimited, -n: 64000, -u: 64000; chỉnh trong /etc/systemd/system/mongod.service [Service] LimitNOFILE=64000 LimitNPROC=64000; hoặc ulimit tạm thời; cho RHEL tạo /etc/security/limits.d/99-mongodb-nproc.conf. | [https://www.mongodb.com/docs/v8.0/reference/ulimit/](https://www.mongodb.com/docs/v8.0/reference/ulimit/) | "Recommended: -f (file size): unlimited, -n (open files): 64000, -u (processes/threads): 64000. Edit /etc/systemd/system/mongod.service [Service] LimitNOFILE=64000 LimitNPROC=64000, then systemctl restart mongod.service." |
| 10. Verify ulimit Settings | Chạy ulimit -a hoặc cat /proc/<pid>/limits cho process đang chạy. | [https://www.mongodb.com/docs/v8.0/reference/ulimit/](https://www.mongodb.com/docs/v8.0/reference/ulimit/) | "Verify: ulimit -a hoặc cat /proc/<pid>/limits." |
| 11. Chuẩn Bị Sharded Cluster Components | Deploy config servers và shards như replica sets trên ≥3 data centers cho HA; thêm multiple mongos với load balancer. | [https://www.mongodb.com/docs/v8.0/core/sharded-cluster-components/](https://www.mongodb.com/docs/v8.0/core/sharded-cluster-components/) | "For production deployments, deploy config server and shard replica sets on at least three data centers to ensure high availability. For shard-level high availability, either add mongos instances on the same hardware where mongod instances are running, or embed mongos routers on the same hardware where the application is hosted." |
| 12. Deploy Sharded Cluster (Sau Tuning) | Cài đặt và deploy config servers, shards, mongos; kiểm tra logs cho warnings về ulimit/THP. | [https://www.mongodb.com/docs/v8.0/tutorial/deploy-sharded-cluster/](https://www.mongodb.com/docs/v8.0/tutorial/deploy-sharded-cluster/) | "Deploy config servers as replica set, shards, then mongos routers. Assumes system tunings completed." |